<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Custom GTA Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        #map {
            width: 100%;
            height: 100vh;
            background: #0fa8d2;
        }
    </style>
</head>
<body style="overflow: hidden; margin: 0;">
    <div id="map"></div>
    <script>
        const center_x = 117.3;
        const center_y = 172.8;
        const scale_x = 0.02072;
        const scale_y = 0.0205;

        CUSTOM_CRS = L.extend({}, L.CRS.Simple, {
            projection: L.Projection.LonLat,
            scale: zoom => Math.pow(2, zoom),
            zoom: sc => Math.log(sc) / Math.LN2,
            distance: (p1, p2) => Math.sqrt(Math.pow(p2.lng - p1.lng, 2) + Math.pow(p2.lat - p1.lat, 2)),
            transformation: new L.Transformation(scale_x, center_x, -scale_y, center_y),
            infinite: true
        });

        var SateliteStyle = L.tileLayer('mapStyles/styleSatelite/{z}/{x}/{y}.jpg', {
            minZoom: 0, maxZoom: 8, noWrap: true, continuousWorld: false, attribution: 'Satelite Style'
        });
        var AtlasStyle = L.tileLayer('mapStyles/styleAtlas/{z}/{x}/{y}.jpg', {
            minZoom: 0, maxZoom: 5, noWrap: true, continuousWorld: false, attribution: 'Atlas Style'
        });
        var GridStyle = L.tileLayer('mapStyles/styleGrid/{z}/{x}/{y}.png', {
            minZoom: 0, maxZoom: 5, noWrap: true, continuousWorld: false, attribution: 'Grid Style'
        });

        var ExampleGroup = L.layerGroup();

        var baseMaps = {
            "Satelite": SateliteStyle,
            "Atlas": AtlasStyle,
            "Grid": GridStyle
        };

        var overlayMaps = {
            "Example Marker": ExampleGroup
        };

        var mymap = L.map('map', {
            crs: CUSTOM_CRS,
            minZoom: 1,
            maxZoom: 5,
            center: [0, 0],
            zoom: 3,
            layers: [AtlasStyle, ExampleGroup]
        });

        L.control.layers(baseMaps, overlayMaps).addTo(mymap);

        function customIcon(icon) {
            return L.icon({
                iconUrl: `blips/${icon}.png`,
                iconSize: [20, 20],
                iconAnchor: [20, 20],
                popupAnchor: [-10, -27]
            });
        }

        // Initial marker from URL params (optional)
        const params = new URLSearchParams(window.location.search);
        const x = parseFloat(params.get('x')) || 0;
        const y = parseFloat(params.get('y')) || 0;

        L.marker([y, x], { icon: customIcon(1) })
            .addTo(ExampleGroup)
            .bindPopup("I am here.");

        mymap.setView([y, x], 4);

        // âœ… Runtime injection function from VB.NET
        window.addHydrantMarkers = function(hydrants) {
            for (const h of hydrants) {
                L.marker([h.y, h.x], { icon: customIcon(1) })
                    .addTo(ExampleGroup)
                    .bindPopup(`Hydrant at [${h.x.toFixed(2)}, ${h.y.toFixed(2)}]`);
            }
        };
    </script>
</body>
</html>
